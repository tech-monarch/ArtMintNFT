<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArtHashChain | Mint Your Digital Art</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --primary: #8247e5;
      --secondary: #1e1e1e;
      --success: #28a745;
      --error: #dc3545;
    }
    body { 
      font-family: Segoe UI, sans-serif; 
      background:#f5f5f5; 
      color: var(--secondary); 
      margin:0; 
      padding:0; 
    }
    .container { 
      max-width: 920px; 
      margin: 20px auto; 
      background: #fff; 
      border-radius: 14px; 
      padding:28px; 
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    header { text-align:center; margin-bottom:20px;}
    h1.logo img { width:160px; display:block; margin:0 auto;}
    .wallet-status { 
      display:inline-block; 
      padding:6px 12px; 
      border-radius:18px; 
      background:#e9ecef; 
      font-size:0.95rem; 
    }
    .form-group { margin-bottom:14px;}
    label { display:block; font-weight:600; margin-bottom:6px;}
    input[type="text"], textarea { 
      width:100%; padding:10px; 
      border:1px solid #d6d6d6; border-radius:8px; 
      font-size:1rem; box-sizing:border-box;
    }
    textarea { min-height:90px; resize: vertical;}
    .image-upload { 
      border:2px dashed #ced4da; 
      padding:16px; border-radius:8px; 
      text-align:center; cursor:pointer; 
    }
    .image-preview { 
      display:block; max-width:100%; 
      margin-top:12px; border-radius:8px; 
      opacity:0; transition:.3s;
    }
    .btn { 
      background: var(--primary); color:white; 
      border:none; padding:12px 18px; 
      border-radius:10px; cursor:pointer; 
      font-weight:700; margin-top:6px;
    }
    .btn:disabled { opacity:.65; cursor:not-allowed; }

    .hash-display, .mint-result, #metadataDisplay { 
      word-break: break-all; padding:10px; 
      border-radius:8px; background:#fafafa; 
      margin-top:12px;
    }

    .status { 
      padding:12px; border-radius:8px; 
      margin-top:14px; display:none; 
      color:white; font-weight:600;
    }
    .status.success { background-color: var(--success); }
    .status.error { background-color: var(--error); }

    .copy-btn {
      padding:6px 10px; 
      font-size:0.85rem; 
      margin-left:6px; 
      border-radius:6px;
      cursor:pointer;
      background:#eee;
      transition:.2s;
    }
    .copy-btn:hover { background:#ddd; }

    #mintResult { 
      display:none; 
      opacity:0; 
      transition:.35s;
    }
    #metadataDisplay {
      opacity:0;
      transition:.35s;
    }
    .copy-btn {
  padding:8px 14px;
  background:#8247e5;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:0.85rem;
  font-weight:600;
  transition:0.25s;
}

.copy-btn:hover {
  background:#6c32d2;
  transform:scale(1.05);
}

.copy-btn:active {
  transform:scale(0.97);
}
#mintResult {
  margin-top:20px;
  padding:18px;
  border-radius:14px;
  background:#f8f4ff;
  border:1px solid #e3d8ff;
  transition:.35s;
}

#mintResult h3 {
  margin-top:0;
  color:#8247e5;
  font-size:1.35rem;
  font-weight:700;
}

  </style>

</head>
<body>

  <div class="container">

    <header>
      <h1 class="logo"><img src="arthashchain.png" alt="ArtHashChain" /></h1>
      <button class="btn" id="connectWallet">Connect Wallet</button>
      <span class="wallet-status" id="walletStatus">Wallet: Not connected</span>
    </header>

    <!-- FORM -->
    <div class="form-group">
      <label>Artwork Title</label>
      <input type="text" id="artTitle" placeholder="Enter artwork title">
    </div>

    <div class="form-group">
      <label>Artist Name</label>
      <input type="text" id="artistName" placeholder="Artist or your name">
    </div>

    <div class="form-group">
      <label>Description</label>
      <textarea id="description" placeholder="Short description"></textarea>
    </div>

    <div class="form-group">
      <label>Upload Artwork</label>
      <div class="image-upload" id="imageUpload">
        <div>Click to upload or drop file</div>
        <input type="file" id="artFile" accept="image/*" style="display:none;">
        <img id="imagePreview" class="image-preview">
      </div>
    </div>

    <button class="btn" id="generateHashBtn" disabled>Generate Hash</button>
    <button class="btn" id="mintBtn" disabled>Mint Artwork</button>

    <!-- HASH -->
    <div id="hashDisplay" class="hash-display" style="display:none;"></div>
    <button id="copyHashBtn" style="display:none;" class="copy-btn">Copy Hash</button>

    <div id="statusMessage" class="status"></div>

    <!-- METADATA PREVIEW -->
    <div id="metadataDisplay">
      <h3>NFT Preview</h3>
      <img id="previewImage" style="max-width:200px; margin-bottom:10px;">
      <p><strong>Title:</strong> <span id="previewTitle"></span></p>
      <p><strong>Artist:</strong> <span id="previewArtist"></span></p>
      <p><strong>Description:</strong> <span id="previewDescription"></span></p>
      <p><strong>SHA-256 Hash:</strong> <span id="previewHash"></span></p>
      <p><strong>Timestamp:</strong> <span id="previewTimestamp"></span></p>
    </div>

    <!-- MINT RESULT -->
    <div id="mintResult">
      <h3>Mint Successful!</h3>
      <p>Contract: 
        <span id="mintContract"></span> 
        <button id="copyContractBtn" class="copy-btn">Copy</button>
      </p>

      <p>Token ID: 
        <span id="mintToken"></span> 
        <button id="copyTokenBtn" class="copy-btn">Copy</button>
      </p>

      <p>Metadata URL: 
        <a id="mintMetadataLink" target="_blank"></a> 
        <button id="copyMetadataBtn" class="copy-btn">Copy</button>
      </p>

      <p><strong>Minted At:</strong> <span id="mintTimestamp"></span></p>
      <button id="downloadCertificateBtn" class="copy-btn" style="margin-top:10px;">
        Download Certificate (PDF)
      </button>

    </div>

  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

  // ======================
  // ðŸ”‘ CONFIG
  // ======================
  const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiIyODAxZjFjZC1lY2QyLTRmOTAtODFmNC1jOWI1YmJmNGU5NWMiLCJlbWFpbCI6Im9kZWlnb25pQGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiI2MWM4NTFmNzhmODkyYjU1MDc2YSIsInNjb3BlZEtleVNlY3JldCI6IjZkYzMyMzc4YjQ2MWY4NmRhNGJhZWRlY2VkZWZjZjU1ZDg5ZmNmOTczN2ZhYWMzYTI0NzgyZTVmMmY1YjdhNDMiLCJleHAiOjE3OTU1NTgwNjB9.5MQoEP09VJGrc_K9inzdAzhyi0c2MKBb2y8IAUYCbTQ";   // <--- CHANGE THIS ONLY

  const CONTRACT_ADDRESS = "0x83adc731564072ca4750e193e5068239a3b2407e";  // <--- YOUR ArtNFT contract
  const ABI = [
    "function mint(string memory tokenURI) public payable returns (uint256)"
  ];

  let provider, signer, userAddress;

  const connectWalletBtn = document.getElementById("connectWallet");
  const walletStatus = document.getElementById("walletStatus");
  const artFile = document.getElementById("artFile");
  const imageUpload = document.getElementById("imageUpload");
  const imagePreview = document.getElementById("imagePreview");
  const generateHashBtn = document.getElementById("generateHashBtn");
  const mintBtn = document.getElementById("mintBtn");
  const hashDisplay = document.getElementById("hashDisplay");
  const copyHashBtn = document.getElementById("copyHashBtn");
  const status = document.getElementById("statusMessage");
  const metadataDisplay = document.getElementById("metadataDisplay");

  function showStatus(txt, type) {
    status.textContent = txt;
    status.className = "status " + type;
    status.style.display = "block";
    setTimeout(() => status.style.display = "none", 3500);
  }

  // ======================
  // WALLET CONNECT
  // ======================
  connectWalletBtn.onclick = async () => {
    if (!window.ethereum) return alert("MetaMask not installed!");

    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    walletStatus.textContent = `Wallet: ${userAddress}`;

    const net = await provider.getNetwork();
    if (net.chainId !== 137) alert("Switch to Polygon Mainnet!");
  };

  // ======================
  // FILE UPLOAD
  // ======================
  imageUpload.onclick = () => artFile.click();

  artFile.onchange = () => {
    if (!artFile.files[0]) return;
    const reader = new FileReader();
    reader.onload = e => {
      imagePreview.src = e.target.result;
      imagePreview.style.opacity = "1";
      generateHashBtn.disabled = false;
    };
    reader.readAsDataURL(artFile.files[0]);
    showStatus("Image loaded.", "success");
  };

  // ======================
  // HASH GENERATION
  // ======================
  generateHashBtn.onclick = async () => {
    if (!artFile.files[0]) 
      return showStatus("Upload an image first", "error");

    const file = artFile.files[0];
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
    const hashHex = "0x" + [...new Uint8Array(hashBuffer)]
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');

    hashDisplay.style.display = "block";
    hashDisplay.textContent = hashHex;
    copyHashBtn.style.display = "inline-block";
    mintBtn.disabled = false;

    document.getElementById("previewImage").src = imagePreview.src;
    document.getElementById("previewTitle").textContent = document.getElementById("artTitle").value;
    document.getElementById("previewArtist").textContent = document.getElementById("artistName").value;
    document.getElementById("previewDescription").textContent = document.getElementById("description").value;
    document.getElementById("previewHash").textContent = hashHex;
    document.getElementById("previewTimestamp").textContent = new Date().toLocaleString();

    metadataDisplay.style.opacity = "1";
  };

  copyHashBtn.onclick = () => {
    navigator.clipboard.writeText(hashDisplay.textContent);
    showStatus("Hash copied!", "success");
  };

  // ======================
  // PINATA UPLOAD FUNCTIONS
  // ======================
  async function uploadFile(file) {
    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
      method: "POST",
      headers: { Authorization: `Bearer ${PINATA_JWT}` },
      body: fd
    });

    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    return `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;
  }

  async function uploadMetadata(json) {
    const res = await fetch("https://api.pinata.cloud/pinning/pinJSONToIPFS", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        Authorization: `Bearer ${PINATA_JWT}`
      },
      body: JSON.stringify(json)
    });

    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    return `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;
  }

  // ======================
  // MINT FUNCTION
  // ======================
mintBtn.onclick = async () => {
  if (!signer) return showStatus("Connect wallet first!", "error");

  mintBtn.disabled = true;
  mintBtn.textContent = "Minting...";

  try {
    // 1ï¸âƒ£ Check wallet balance
    const balance = await provider.getBalance(userAddress);
    const mintPrice = ethers.utils.parseEther("1.0"); // your mint cost
    const gasEstimate = ethers.utils.parseUnits("0.05", "ether"); // approx gas buffer

    if (balance.lt(mintPrice.add(gasEstimate))) {
      showStatus("Insufficient MATIC for mint + gas. Please fund your wallet.", "error");
      mintBtn.disabled = false;
      mintBtn.textContent = "Mint Artwork";
      return;
    }

    // 2ï¸âƒ£ Upload image
    showStatus("Uploading image to IPFS...", "success");
    const imageURL = await uploadFile(artFile.files[0]);

    // 3ï¸âƒ£ Upload metadata
    const metadata = {
      name: document.getElementById("artTitle").value,
      artist: document.getElementById("artistName").value,
      description: document.getElementById("description").value,
      image: imageURL,
      hash: hashDisplay.textContent,
      timestamp: new Date().toISOString()
    };

    showStatus("Uploading metadata to IPFS...", "success");
    const metadataURL = await uploadMetadata(metadata);

    // 4ï¸âƒ£ Mint NFT
    showStatus("Minting on Polygon...", "success");
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    const tx = await contract.mint(metadataURL, { value: mintPrice });
    showStatus("Waiting for blockchain confirmation...", "success");
    const receipt = await tx.wait();

    // 5ï¸âƒ£ Handle token ID
    let tokenId = null;
    if (receipt && receipt.events) {
      for (const e of receipt.events) {
        if (e.event === "Transfer" && e.args) {
          tokenId = e.args[2]?.toString() || e.args[0]?.toString();
          break;
        }
      }
    }
    if (!tokenId) {
      tokenId = tx.hash;
      showStatus("No Transfer event found. Using tx hash as token ID.", "error");
    }

    // 6ï¸âƒ£ Display mint result
    document.getElementById("mintContract").textContent = CONTRACT_ADDRESS;
    document.getElementById("mintToken").textContent = tokenId;
    document.getElementById("mintMetadataLink").href = metadataURL;
    document.getElementById("mintMetadataLink").textContent = metadataURL;
    document.getElementById("mintTimestamp").textContent = new Date().toLocaleString();

    const mintResult = document.getElementById("mintResult");
    mintResult.style.display = "block";
    setTimeout(() => mintResult.style.opacity = "1", 50);

    showStatus("NFT Minted Successfully!", "success");

  } catch (err) {
    console.error(err);
    showStatus(err.message || "Mint failed", "error");
  }

  mintBtn.disabled = false;
  mintBtn.textContent = "Mint Artwork";
};

  // ======================
  // COPY BUTTONS
  // ======================
  document.getElementById("copyContractBtn").onclick = () => {
    navigator.clipboard.writeText(document.getElementById("mintContract").textContent);
    showStatus("Contract copied!", "success");
  };
  document.getElementById("copyTokenBtn").onclick = () => {
    navigator.clipboard.writeText(document.getElementById("mintToken").textContent);
    showStatus("Token ID copied!", "success");
  };
  document.getElementById("copyMetadataBtn").onclick = () => {
    navigator.clipboard.writeText(document.getElementById("mintMetadataLink").href);
    showStatus("Metadata URL copied!", "success");
  };





  // ======================
// ðŸ“„ DOWNLOAD CERTIFICATE (PDF)
// ======================
document.getElementById("downloadCertificateBtn").onclick = async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const imgData = document.getElementById("previewImage").src;
  const title = document.getElementById("previewTitle").textContent;
  const artist = document.getElementById("previewArtist").textContent;
  const desc = document.getElementById("previewDescription").textContent;
  const hash = document.getElementById("previewHash").textContent;
  const timestamp = document.getElementById("previewTimestamp").textContent;
  const metadataURL = document.getElementById("mintMetadataLink").href;
  const tokenID = document.getElementById("mintToken").textContent;

  // Header
  doc.setFontSize(18);
  doc.text("ArtHashChain NFT Certificate", 105, 15, { align: "center" });

  // Image
  try {
    doc.addImage(imgData, "JPEG", 15, 25, 60, 60);
  } catch (e) {
    console.log("Image error:", e);
  }

  // Details
  doc.setFontSize(12);
  doc.text(`Title: ${title}`, 15, 95);
  doc.text(`Artist: ${artist}`, 15, 105);
  doc.text(`Description: ${desc}`, 15, 115);
  doc.text(`Token ID: ${tokenID}`, 15, 125);
  doc.text(`SHA-256 Hash:`, 15, 135);
  doc.text(hash, 15, 142);
  doc.text(`Minted At: ${timestamp}`, 15, 152);
  doc.text("Metadata URL:", 15, 162);

  // Long URL wrap
  doc.setFontSize(10);
  const splitURL = doc.splitTextToSize(metadataURL, 180);
  doc.text(splitURL, 15, 170);

  // Footer
  doc.setFontSize(10);
  doc.text("Â© Reuben Igoni Art Foundation - NFT Mint Certificate", 105, 290, { align: "center" });

  // Save PDF
  doc.save(`NFT-Certificate-${tokenID}.pdf`);
};

</script>
<footer style="
  background: #8247e5;
  color: white;
  padding: 20px 0;
  text-align: center;
  font-family: Arial, sans-serif;
  font-size: 14px;
">
  Â© Reuben Igoni Art Foundation 2025
</footer>

</body>
</html>
